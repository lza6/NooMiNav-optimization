# FlarePortal 完整CF功能模拟服务器使用说明

## 概述

本项目提供了一个完整的 Cloudflare Workers 功能模拟环境，旨在让开发者能够在本地完全模拟生产环境的功能，包括：

- 请求处理和路由
- 环境变量模拟
- D1 数据库操作模拟
- Cookie 和 Session 管理
- 数据统计和记录
- 完整的前后端交互

## 目录结构

```
本地测试专用/
├── local_server_full_cf_simulation.js  # 完整CF功能模拟服务器
├── install_dependencies.bat            # 安装依赖脚本
├── start_local_test.bat               # 启动服务器脚本
└── 使用说明.md                        # 本文档
```

## 快速开始

### 1. 环境要求

- Windows 操作系统
- Node.js (v14 或更高版本)
- 网络连接（用于安装依赖）

### 2. 安装步骤

1. **安装 Node.js**
   - 访问 https://nodejs.org/
   - 下载并安装最新 LTS 版本

2. **安装项目依赖**
   - 双击运行 `install_dependencies.bat`
   - 等待安装完成

3. **启动本地服务器**
   - 双击运行 `start_local_test.bat`
   - 等待服务器启动成功

### 3. 访问应用

- **主页**: http://localhost:8787
- **管理后台**: http://localhost:8787/admin
- **管理密码**: test123

## 完整CF功能模拟

### 1. 请求处理模拟

- 完整模拟 Cloudflare Workers 的请求处理流程
- 支持 GET、POST 等 HTTP 方法
- 模拟 URL 路由和参数解析

### 2. 环境变量模拟

- 模拟 Cloudflare 环境变量系统
- 支持 TITLE、SUBTITLE、admin、img 等配置项
- 支持 LINKS 和 FRIENDS JSON 配置

### 3. D1 数据库模拟

- 完整模拟 D1 数据库操作
- 支持 SQL 查询和更新操作
- 数据持久化存储到本地文件

### 4. Cookie 和 Session 管理

- 模拟 Cookie 设置和读取
- 实现 Session 认证机制
- 支持管理员登录状态管理

### 5. 数据统计功能

- 记录链接点击事件
- 统计总点击、月点击、日点击
- 生成详细访问日志

## 功能特性

### 主页功能
- 导航项目展示
- 搜索功能
- 主题切换（亮色/暗色）
- 响应式设计
- 动画效果

### 管理后台功能
- 登录验证
- 数据统计概览
- 项目点击统计
- 访问日志查看
- 月份选择器
- 顶部统计面板

### 数据持久化
- 数据存储在 `./data/db.json`
- 重启后数据保持
- 模拟真实数据库行为

## 与生产环境的对比

| 功能 | 生产环境 (CF) | 本地模拟 | 差异说明 |
|------|---------------|----------|----------|
| 数据库存储 | Cloudflare D1 | 本地 JSON 文件 | 存储介质不同 |
| 并发处理 | CF 全局并发 | Node.js 单进程 | 并发模型不同 |
| 网络延迟 | 真实网络 | 本地回环 | 延迟几乎为零 |
| 安全性 | CF 安全机制 | 基础验证 | 安全级别较低 |
| 功能完整性 | 100% | ~95% | 本地环境限制 |

## 故障排除

### 常见问题

1. **Node.js 未找到**
   - 确认已安装 Node.js
   - 检查环境变量 PATH

2. **端口已被占用**
   - 关闭其他占用 8787 端口的应用
   - 修改 local_server_full_cf_simulation.js 中的端口号

3. **依赖安装失败**
   - 检查网络连接
   - 尝试手动运行 `npm install express`

4. **数据库文件权限错误**
   - 确保对项目目录有写入权限
   - 检查 `./data/` 目录是否存在

### 调试方法

- 查看控制台输出的错误信息
- 检查 `./data/db.json` 文件内容
- 确认环境变量配置正确

## 高级配置

### 修改环境变量

编辑 `local_server_full_cf_simulation.js` 文件中的 `env` 对象：

```javascript
const env = {
  TITLE: "您的标题",
  SUBTITLE: "您的副标题",
  admin: "您的密码",
  // ...
};
```

### 更改端口

修改 `local_server_full_cf_simulation.js` 文件末尾的端口号：

```javascript
const port = 8787;  // 修改为其他端口
```

## 数据备份与恢复

### 备份数据

复制 `./data/db.json` 文件到安全位置

### 恢复数据

将备份的 `db.json` 文件复制回 `./data/` 目录

## 注意事项

- 本地模拟服务器仅供开发和测试使用
- 生产环境功能更加完整和安全
- 本地数据不会同步到 Cloudflare
- 不应用于生产环境部署
- 仅限个人开发使用

## 技术架构

- **后端**: Node.js + Express
- **数据库**: 本地 JSON 文件模拟 D1
- **前端**: 原始 HTML/CSS/JavaScript
- **通信**: HTTP/HTTPS

## 更新日志

- **V2.0**: 完整CF功能模拟，支持数据库持久化
- **V1.0**: 基础功能模拟

## 联系支持

如遇问题，请检查配置和环境要求，或联系项目维护者。